(()=>{"use strict";let e=null,t=null,n=null,o=null,s=!1,r=!1,c=0,a=2e3,l=null,i=null,d=null,m=null,u=0,g=new Map;function v(){"visible"===document.visibilityState&&(console.log("패널이 다시 보이게 됨, 연결 상태 확인 중..."),s||r?W({type:"ping",sessionId:i},3e3).then((e=>{console.log("핑 응답 수신:",e)})).catch((e=>{console.warn("핑 응답 없음, 연결 재설정 필요:",e),D(),h()})):(console.log("연결이 끊어진 상태 감지됨, 재연결 시도..."),h()))}function p(e){console.warn(`연결 재설정 필요: ${e}`),D(),s=!1,r=!1,$(`연결이 끊어졌습니다: ${e}. 재연결 중...`,!1),f(`연결이 재설정되었습니다: ${e}. 자동으로 재연결을 시도합니다.`),w()}function w(){if(r)return void console.log("이미 재연결 중입니다.");console.log("재연결 예약 중..."),r=!0,c=0;const e=Math.min(1e3*Math.pow(1.5,c),1e4);console.log(`${e}ms 후 재연결 시도`),setTimeout((()=>{try{"visible"===document.visibilityState?(console.log("재연결 시도 시작"),h()):(console.log("페이지가 보이지 않음, 재연결 대기 중"),document.addEventListener("visibilitychange",(function e(){"visible"===document.visibilityState&&(document.removeEventListener("visibilitychange",e),console.log("페이지가 다시 표시됨, 재연결 시도"),h())}),{once:!0}))}catch(e){console.error("재연결 스케줄링 중 오류:",e),r=!1}}),e)}function E(){D(),s=!1,r=!1,c=0,$("수동 재연결 중...",!1),setTimeout((()=>{h()}),500)}function h(){if(r){if(c>10)return console.error("최대 재연결 시도 횟수를 초과했습니다."),$("재연결 실패. 수동으로 다시 시도하세요.",!1),f("연결 시도 횟수 초과. '재연결' 버튼을 눌러 다시 시도하세요.",!0),void(r=!1);c++,$(`재연결 시도 중... (${c}/10)`,!1)}else $("연결 중...",!1);D();try{b();const e=chrome.devtools.inspectedWindow.tabId,t=`devtools-${e}-${i}`;console.log(`새 포트 연결 생성: ${t}`);try{if(d=chrome.runtime.connect({name:t}),chrome.runtime.lastError)throw new Error(chrome.runtime.lastError.message);d&&(d.onMessage.addListener(M),d.onDisconnect.addListener(y)),function(e){if(d)try{d.postMessage({type:"devtools-init",tabId:e,sessionId:i,timestamp:Date.now(),devtoolsInfo:{url:window.location.href,userAgent:navigator.userAgent}})}catch(e){console.error("초기화 메시지 전송 실패:",e)}}(e),console.log("포트 연결 성공"),$("포트 연결됨, 워커풀 연결 중...",!1),x(),m&&clearInterval(m),m=setInterval((()=>{if(!d)return console.warn("포트 연결이 없습니다. 재연결 시도..."),clearInterval(m),m=null,void(r||w());W({type:"ping",timestamp:Date.now()},2e3).then((e=>{console.log("핑 응답 수신:",e),e&&e.success&&(s||(console.log("연결이 복구되었습니다."),s=!0,$("연결됨",!0)))})).catch((e=>{console.warn("포트 핑 실패:",e),e.message.includes("Extension context invalidated")?_("컨텍스트 무효화 (핑 중)"):d&&(D(),w())}))}),15e3)}catch(e){console.error("포트 연결 실패:",e),function(e){const t=e?.message||"알 수 없는 오류",n=t.includes("Extension context invalidated"),o=t.includes("port closed")||t.includes("disconnected");console.warn(`포트 연결 실패: ${t}`),n?($("확장 프로그램 컨텍스트 무효화됨",!1),f("확장 프로그램 컨텍스트가 무효화되었습니다. 자동으로 복구를 시도합니다."),_("컨텍스트 무효화")):o?($("연결이 닫혔습니다",!1),D(),I(1e3)):($(`연결 오류: ${t}`,!1),I(3e3))}(e)}}catch(e){console.error("연결 초기화 중 오류:",e),$(`연결 오류: ${e.message}`,!1),f(`연결 오류: ${e.message}. 자동으로 다시 시도합니다.`),I(5e3)}}function y(e){const t=chrome.runtime.lastError,n=t?t.message:"알 수 없는 원인";console.warn(`포트 연결 해제 발생: ${n}`),d=null,s=!1,$(`연결 끊김: ${n}`,!1),n.includes("Extension context invalidated")?_("컨텍스트 무효화 (포트 연결 해제)"):p(`포트 연결 해제: ${n}`),q("포트 연결 해제")}function I(e){const t=e||2e3,n=Math.min(t*Math.pow(1.5,Math.min(c,5)),2e4);console.log(`${n}ms 후 재연결 시도 예약 (시도 ${c}/10)`),setTimeout((()=>{s||w()}),n)}function f(e,t=!1){console.warn("오류:",e);const n=document.getElementById("error-container");if(!n)return;n.innerHTML="";const o=document.createElement("p");if(o.className="error-message",o.textContent=e,n.appendChild(o),e.includes("워커풀을 찾을 수 없음")){const e=document.createElement("p");e.textContent="HyperViz가 페이지에 로드되었는지 확인하세요.",n.appendChild(e);const t=document.createElement("button");t.id="btn-create-mock-pool",t.className="btn btn-warning btn-sm",t.textContent="가상 워커풀 생성",t.addEventListener("click",L),n.appendChild(t)}if(t||e.includes("컨텍스트 무효화")||c>5){const e=document.createElement("button");e.className="btn btn-primary btn-sm mt-2",e.textContent="연결 재시도",e.addEventListener("click",E),n.appendChild(e)}n.style.display="block",t||e.includes("컨텍스트 무효화")||e.includes("워커풀을 찾을 수 없음")||setTimeout((()=>{b()}),5e3)}function b(){const e=document.getElementById("error-container");e&&(e.style.display="none")}function $(e,t){const n=document.getElementById("connection-status");if(!n)return;n.textContent=e,n.className=t?"connection-status connected":"connection-status disconnected";const o=document.getElementById("connection-indicator");o&&(o.className=t?"indicator connected":"indicator disconnected");const s=document.getElementById("btn-reconnect");s&&(s.disabled=t,t?(s.classList.remove("btn-danger","btn-warning"),s.classList.add("btn-secondary")):c>5?(s.classList.remove("btn-secondary"),s.classList.add("btn-danger")):(s.classList.remove("btn-secondary","btn-danger"),s.classList.add("btn-warning")))}function x(){$("워커풀 연결 중...",!1),s=!1,W({type:"devtools_connect_request",tabId:chrome.devtools.inspectedWindow.tabId,sessionId:i,timestamp:Date.now()},5e3,2).then((e=>{if(!e)throw new Error("응답 없음");if(e.error)throw new Error(e.error);if(!e.exists&&!e.success)return $("워커풀을 찾을 수 없음",!1),l="워커풀을 찾을 수 없음",void f("페이지에서 HyperViz 워커풀을 찾을 수 없습니다.",!0);console.log("워커풀 연결 성공! 버전:",e.version||"unknown"),s=!0,r=!1,c=0,$("연결됨",!0),b(),setTimeout(k,500)})).catch((e=>{console.error("워커풀 연결 실패:",e),f(`워커풀 연결 실패: ${e.message}`),l=e.message,e.message.includes("Extension context invalidated")?_("컨텍스트 무효화 (워커풀 연결 중)"):e.message.includes("포트 연결이 없습니다")?p("포트 연결 없음"):($(`연결 실패: ${e.message}`,!1),I(3e3))}))}function k(){s?(console.log("워커풀 데이터 요청 중..."),W({type:"devtools_fetch_data",tabId:chrome.devtools.inspectedWindow.tabId,timestamp:Date.now()},5e3,1).then((e=>{if(!e)throw new Error("응답 없음");if(e.error)throw new Error(e.error);const n=e.data;if(!n)throw new Error("데이터 없음");console.log("워커풀 데이터 수신:",n),o=n,B(n),t||(t&&clearInterval(t),t=setInterval((()=>{s&&k()}),a),console.log(`데이터 폴링 시작 (${a}ms 간격)`)),l=null})).catch((e=>{console.error("데이터 요청 중 오류:",e),f(`데이터 가져오기 실패: ${e.message}`),e.message.includes("Extension context invalidated")?(s=!1,$("확장 프로그램 컨텍스트 무효화됨. 재연결 필요",!1),_("컨텍스트 무효화 (데이터 요청 중)")):e.message.includes("포트 연결이 없습니다")&&(s=!1,$("연결이 끊어졌습니다. 재연결 중...",!1),p("포트 연결 없음 (데이터 요청 중)"))}))):console.warn("워커풀에 연결되지 않았습니다. 데이터를 가져올 수 없습니다.")}function B(e){e&&($("연결됨",!0),function(e){if(e)try{const t=e.workers?.length||0,n=e.workers?.filter((e=>"active"===e.status))?.length||0,o=t-n,s=e.tasks||{},r=s.waiting||0,c=s.active||0;document.getElementById("worker-count").textContent=t,document.getElementById("active-workers").textContent=n,document.getElementById("idle-workers").textContent=o,document.getElementById("queued-tasks").textContent=r,document.getElementById("active-tasks").textContent=c;const a=(c/Math.max(t,1)).toFixed(2);document.getElementById("tasks-per-worker").textContent=a;const l=t>0?Math.round(n/t*100):0,i=document.getElementById("worker-usage-bar");i.style.width=`${l}%`,i.textContent=`${l}%`,i.className=l<30?"progress-bar bg-success":l<70?"progress-bar bg-warning":"progress-bar bg-danger"}catch(e){console.error("워커풀 상태 업데이트 중 오류:",e)}}(e),function(e){if(e&&e.tasks)try{const t=e.tasks;document.getElementById("total-tasks").textContent=t.total||0,document.getElementById("completed-tasks").textContent=t.completed||0,document.getElementById("failed-tasks").textContent=t.failed||0;const o=t.total>0?Math.round(t.completed/t.total*100):0;document.getElementById("completion-rate").textContent=`${o}%`;const s=t.waiting||0,r=t.active||0,c=t.completed||0,a=t.failed||0;n&&(n.data.datasets[0].data=[s,r,c,a],n.update())}catch(e){console.error("태스크 정보 업데이트 중 오류:",e)}}(e),e.logs&&function(e){if(!e||!e.length)return;const t=document.getElementById("logs-container");t&&(t.innerHTML="",e.forEach((e=>{const n=document.createElement("div");n.className="log-item","error"===e.level?n.classList.add("log-error"):"warn"===e.level?n.classList.add("log-warning"):"info"===e.level&&n.classList.add("log-info");const o=new Date(e.timestamp).toISOString();n.innerHTML=`<span class="log-timestamp">[${o}]</span> ${e.message}`,t.appendChild(n)})),t.scrollTop=t.scrollHeight)}(e.logs))}function L(){W({type:"devtools_create_mock_pool",tabId:chrome.devtools.inspectedWindow.tabId}).then((e=>{e&&e.success?(console.log("가상 워커풀 생성됨"),b(),setTimeout((()=>{x()}),1e3)):f("가상 워커풀 생성 실패: "+(e?.error||"알 수 없는 오류"))})).catch((e=>{console.error("가상 워커풀 생성 오류:",e),f(`가상 워커풀 생성 실패: ${e.message}`),e.message.includes("Extension context invalidated")&&p("컨텍스트 무효화 (가상 워커풀 생성 중)")}))}function C(){e&&clearInterval(e),e=setInterval((()=>{s&&k()}),a),console.log(`자동 새로고침 시작 (${a}ms 간격)`)}function T(){e&&(clearInterval(e),e=null,console.log("자동 새로고침 중지")),t&&(clearInterval(t),t=null,console.log("데이터 폴링 중지"))}function M(e){if(console.log("포트 메시지 수신:",e),e.requestId&&g.has(e.requestId)){const{resolve:t,reject:n,timer:o}=g.get(e.requestId);return clearTimeout(o),g.delete(e.requestId),void(e.error?n(new Error(e.error)):t(e))}"workerPoolDataUpdate"===e.type&&e.data&&(console.log("워커풀 데이터 업데이트 수신:",e.data),o=e.data,B(e.data))}function _(e){console.warn(`심각한 연결 오류 발생: ${e}`),D(),s=!1,r=!1,$(`심각한 연결 오류: ${e}. 복구 중...`,!1),setTimeout((()=>{w()}),2e3),setTimeout((()=>{s||f("연결을 자동으로 복구할 수 없습니다. DevTools를 닫고 다시 여세요.",!0)}),3e4)}function D(){if(m&&(clearInterval(m),m=null),d){try{d.disconnect()}catch(e){console.log("포트 연결 정리 중 오류 (무시됨):",e.message)}d=null}q("연결 재설정")}function W(e,t=5e3,n=3){let o=0;return new Promise(((c,a)=>{!function l(){if(!d)return a(new Error("포트 연결이 없습니다"));const i=++u;e.requestId=i;const m=Date.now(),v=setTimeout((()=>{g.has(i)&&(g.delete(i),o<n?(console.warn(`요청 #${i} 시간 초과, 재시도 ${o+1}/${n}`),o++,l()):a(new Error(`요청 시간 초과 (${t}ms)`)))}),t);g.set(i,{resolve:c,reject:a,timer:v,startTime:m,type:e.type});try{d.postMessage(e),console.log(`메시지 전송 #${i}:`,e.type)}catch(e){clearTimeout(v),g.delete(i),o<n?(console.warn(`메시지 전송 오류, 재시도 ${o+1}/${n}:`,e),d?(o++,l()):setTimeout((()=>{s||r||h(),o++,l()}),1e3)):a(e)}}()}))}function q(e){0!==g.size&&(console.log(`대기 중인 요청 ${g.size}개 거부: ${e}`),g.forEach(((t,n)=>{clearTimeout(t.timer),t.reject(new Error(`요청 취소됨: ${e}`));const o=Date.now()-t.startTime;console.log(`요청 #${n} 취소: ${t.type}, 대기 시간: ${o}ms`)})),g.clear())}document.addEventListener("DOMContentLoaded",(()=>{initializePanel()})),window.initializePanel=function(){console.log("WorkerPool 패널 초기화 중..."),i="session_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),console.log(`새 세션 ID 생성됨: ${i}`),document.getElementById("btn-refresh").addEventListener("click",(()=>{k()})),document.getElementById("autoRefreshToggle").addEventListener("change",(e=>{e.target.checked?C():T()})),document.getElementById("refresh-rate").addEventListener("change",(t=>{a=parseInt(t.target.value,10),e&&(T(),C())})),document.getElementById("btn-apply-settings").addEventListener("click",(()=>{!function(){const e=parseInt(document.getElementById("min-workers").value,10),t=parseInt(document.getElementById("max-workers").value,10),n=parseInt(document.getElementById("idle-timeout").value,10),o=parseInt(document.getElementById("task-timeout").value,10);e>t?alert("최소 워커 수는 최대 워커 수보다 클 수 없습니다."):W({type:"devtools_update_pool_settings",tabId:chrome.devtools.inspectedWindow.tabId,settings:{minWorkers:e,maxWorkers:t,idleTimeout:n,taskTimeout:o}}).then((e=>{e&&e.success?(alert("워커풀 설정이 성공적으로 적용되었습니다."),k()):alert(`워커풀 설정 적용 실패: ${e?.error||"알 수 없는 오류"}`)})).catch((e=>{console.error("설정 적용 오류:",e),alert(`워커풀 설정 적용 실패: ${e.message}`),e.message.includes("Extension context invalidated")&&p("컨텍스트 무효화 (설정 적용 중)")}))}()})),document.getElementById("btn-reset-settings").addEventListener("click",(()=>{document.getElementById("min-workers").value=2,document.getElementById("max-workers").value=8,document.getElementById("idle-timeout").value=3e4,document.getElementById("task-timeout").value=1e4})),document.getElementById("btn-terminate-all").addEventListener("click",(()=>{s?confirm("정말 모든 워커를 종료하시겠습니까?")&&W({type:"devtools_terminate_all_workers",tabId:chrome.devtools.inspectedWindow.tabId}).then((e=>{if(!e||!e.success){const t=e&&e.error?e.error:"알 수 없는 오류";throw new Error(t)}console.log("모든 워커가 종료되었습니다"),alert("모든 워커가 성공적으로 종료되었습니다."),setTimeout(k,500)})).catch((e=>{console.error("종료 요청 중 오류:",e),f("워커를 종료할 수 없습니다: "+e.message),e.message.includes("Extension context invalidated")&&p("컨텍스트 무효화 (워커 종료 중)")})):f("워커풀에 연결되어 있지 않습니다")})),document.getElementById("btn-reconnect").addEventListener("click",(()=>{E()})),document.addEventListener("visibilitychange",v),function(){const e=document.getElementById("taskChart").getContext("2d");n&&n.destroy(),n=new Chart(e,{type:"doughnut",data:{labels:["대기 중","실행 중","완료됨","실패"],datasets:[{data:[0,0,0,0],backgroundColor:["#6c757d","#0d6efd","#198754","#dc3545"],borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"right"}}}})}(),window.addEventListener("error",(e=>{console.error("오류 발생:",e.message),e.message&&e.message.includes("Extension context invalidated")&&(console.warn("확장 프로그램 컨텍스트가 무효화되었습니다."),$("확장 프로그램 컨텍스트 무효화됨. 재연결 필요",!1),p("컨텍스트 무효화"))})),window.addEventListener("unhandledrejection",(e=>{console.error("처리되지 않은 프로미스 거부:",e.reason),e.reason&&(e.reason.message&&e.reason.message.includes("Extension context invalidated")||e.reason.toString().includes("Extension context invalidated"))&&p("컨텍스트 무효화 (프로미스)")})),c=0,h(),C()}})();