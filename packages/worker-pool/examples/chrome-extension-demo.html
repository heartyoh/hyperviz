<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HyperViz WorkerPool 데모</title>
    <script type="importmap">
      {
        "imports": {
          "eventemitter3": "https://cdn.jsdelivr.net/npm/eventemitter3@5.0.1/dist/eventemitter3.esm.js"
        }
      }
    </script>
    <style>
      body {
        font-family: "Arial", sans-serif;
        line-height: 1.6;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #4a86e8;
        margin-top: 0;
      }
      .actions {
        margin: 20px 0;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }
      button {
        background-color: #4a86e8;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.3s;
      }
      button:hover {
        background-color: #366dc7;
      }
      .stats {
        margin-top: 20px;
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        border-left: 4px solid #4a86e8;
      }
      .logs {
        margin-top: 20px;
        height: 300px;
        overflow-y: auto;
        background-color: #2d2d2d;
        color: #f1f1f1;
        padding: 10px;
        border-radius: 4px;
        font-family: monospace;
      }
      .task-info {
        margin-top: 20px;
        background-color: #e8f4ff;
        padding: 15px;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>HyperViz WorkerPool 데모</h1>
      <p>
        이 데모는 HyperViz 워커풀 라이브러리와 크롬 확장 프로그램 간의 연결을
        보여줍니다.
      </p>

      <div class="actions">
        <button id="createTasks">태스크 생성</button>
        <button id="createLotsOfTasks">대량 태스크 생성 (50개)</button>
        <button id="clearTasks">태스크 초기화</button>
      </div>

      <div class="stats" id="poolStats">
        <h3>워커풀 상태</h3>
        <div>워커 수: <span id="workerCount">0</span></div>
        <div>활성 워커: <span id="activeWorkers">0</span></div>
        <div>유휴 워커: <span id="idleWorkers">0</span></div>
        <div>대기 중인 태스크: <span id="queuedTasks">0</span></div>
        <div>활성 태스크: <span id="activeTasks">0</span></div>
      </div>

      <div class="task-info" id="taskInfo">
        <h3>태스크 정보</h3>
        <div>총 태스크: <span id="totalTasks">0</span></div>
        <div>완료된 태스크: <span id="completedTasks">0</span></div>
        <div>실패한 태스크: <span id="failedTasks">0</span></div>
      </div>

      <div class="logs" id="logs"></div>
    </div>

    <script type="module">
      import {
        UnifiedWorkerPoolManager,
        WorkerType,
        LogLevel,
        TaskPriority,
      } from "../dist/index.js";

      // 전역 변수
      let manager;
      let taskCounter = {
        total: 0,
        completed: 0,
        failed: 0,
      };

      // 로그 추가 함수
      function addLog(message) {
        const logs = document.getElementById("logs");
        const logEntry = document.createElement("div");
        logEntry.textContent = `[${new Date().toISOString()}] ${message}`;
        logs.appendChild(logEntry);
        logs.scrollTop = logs.scrollHeight;
      }

      // 상태 업데이트 함수
      function updateStats() {
        if (!manager) return;

        const stats = manager.getPoolStats().get(WorkerType.CALC);
        if (stats) {
          document.getElementById("workerCount").textContent =
            stats.workerCount;
          document.getElementById("activeWorkers").textContent =
            stats.activeWorkers;
          document.getElementById("idleWorkers").textContent =
            stats.idleWorkers;
          document.getElementById("queuedTasks").textContent =
            stats.queuedTasks;
          document.getElementById("activeTasks").textContent =
            stats.activeTasks;
        }

        document.getElementById("totalTasks").textContent = taskCounter.total;
        document.getElementById("completedTasks").textContent =
          taskCounter.completed;
        document.getElementById("failedTasks").textContent = taskCounter.failed;
      }

      // 워커풀 매니저 초기화
      async function initializeWorkerPool() {
        addLog("워커풀 매니저 초기화 중...");

        // 매니저 생성
        manager = new UnifiedWorkerPoolManager({
          poolConfig: {
            minWorkers: 2,
            maxWorkers: 8,
            idleTimeout: 30000,
          },
          taskTimeout: 10000,
          retryLimit: 1,
          autoCreatePools: true,
          logLevel: LogLevel.DEBUG,
          metricsInterval: 2000,
          maxLogEntries: 100,
          initialPools: {
            [WorkerType.CALC]: { minWorkers: 2, maxWorkers: 8 },
          },
          // 확장 프로그램 통신 활성화
          enableExtensionCommunication: true,
        });

        // 태스크 유형을 워커 유형에 매핑
        manager.registerTaskType("matrix", WorkerType.CALC);

        // 이벤트 핸들러 등록
        const dispatcher = manager.getDispatcher();

        dispatcher.on("taskQueued", (event) => {
          addLog(`태스크 큐에 추가됨: ${event.taskId}`);
          updateStats();
        });

        dispatcher.on("taskCompleted", (event) => {
          addLog(`태스크 완료됨: ${event.taskId}`);
          taskCounter.completed++;
          updateStats();
        });

        dispatcher.on("taskFailed", (event) => {
          addLog(`태스크 실패: ${event.taskId}, 오류: ${event.error}`);
          taskCounter.failed++;
          updateStats();
        });

        // 매니저 초기화
        try {
          await manager.initialize();
          addLog("워커풀 매니저가 성공적으로 초기화되었습니다.");

          // 초기 상태 업데이트
          updateStats();

          // 통계 정기 업데이트
          setInterval(updateStats, 1000);

          addLog("확장 프로그램과의 통신이 활성화되었습니다.");
        } catch (error) {
          addLog(`초기화 오류: ${error.message}`);
          console.error("워커풀 초기화 오류:", error);
        }
      }

      // 하나의 태스크 생성
      function createTask() {
        if (!manager) {
          addLog("오류: 워커풀 매니저가 초기화되지 않았습니다.");
          return;
        }

        const priority =
          Math.random() > 0.7 ? TaskPriority.HIGH : TaskPriority.NORMAL;
        const dimensions = Math.floor(Math.random() * 100) + 100;

        try {
          const taskId = manager.submitTask(
            "matrix",
            {
              dimensions: [dimensions, dimensions],
              operation: "multiply",
            },
            { priority }
          );

          addLog(
            `새 태스크 생성됨 (${
              priority === TaskPriority.HIGH ? "높음" : "보통"
            } 우선순위): ${taskId}`
          );
          taskCounter.total++;
          updateStats();

          return taskId;
        } catch (error) {
          addLog(`태스크 생성 오류: ${error.message}`);
          console.error("태스크 생성 오류:", error);
        }
      }

      // 대량의 태스크 생성
      function createLotsOfTasks(count = 50) {
        if (!manager) {
          addLog("오류: 워커풀 매니저가 초기화되지 않았습니다.");
          return;
        }

        addLog(`${count}개의 태스크 생성 중...`);

        for (let i = 0; i < count; i++) {
          setTimeout(() => {
            createTask();
          }, i * 100); // 100ms 간격으로 생성
        }
      }

      // 태스크 초기화
      function clearTasks() {
        if (!manager) {
          addLog("오류: 워커풀 매니저가 초기화되지 않았습니다.");
          return;
        }

        addLog("태스크 초기화 중...");

        taskCounter = {
          total: 0,
          completed: 0,
          failed: 0,
        };

        updateStats();
        addLog("태스크 카운터가 초기화되었습니다.");
      }

      // 이벤트 리스너 등록
      document.addEventListener("DOMContentLoaded", () => {
        // 초기화
        initializeWorkerPool().catch((error) => {
          console.error("워커풀 초기화 실패:", error);
          addLog(`워커풀 초기화 실패: ${error.message}`);
        });

        // 버튼 이벤트 처리
        document.getElementById("createTasks").addEventListener("click", () => {
          createTask();
        });

        document
          .getElementById("createLotsOfTasks")
          .addEventListener("click", () => {
            createLotsOfTasks();
          });

        document.getElementById("clearTasks").addEventListener("click", () => {
          clearTasks();
        });
      });
    </script>
  </body>
</html>
